---
theme: seriph
background: https://source.unsplash.com/collection/94734566/1920x1080
class: 'text-center'
title: 'å†™ç»™å°å¼¥åŒå­¦çš„ Node ç¼–ç¨‹è¯¾'
highlighter: shiki
lineNumbers: false
drawings:
    persist: false
css: unocss
---

# ABOUT ME

- B ç«™ï¼š[MASH_OSMANTHUS](https://space.bilibili.com/3995594)
- GitHub: https://github.com/kinglisky
- æ˜é‡‘ï¼šhttps://juejin.cn/user/817692380016519


---

# æ¥”å­

ã€‚ã€‚ã€‚

å°å¼¥ï¼šã€Œä¹‹å‰é‚£ä¸ªå½•å±è½¯ä»¶å’‹ç”¨ï¼Œæˆ‘è¦å½•è¯¾~ã€

æˆ‘ï¼šã€Œå½•å•¥è¯¾ï¼Œä½ ä»¬ä¸æ˜¯ç–«æƒ…å‘è§†é¢‘èµ„æ–™ç»™å­¦ç”Ÿå°±å¥½äº†ï¼Ÿã€

å°å¼¥ï¼šã€Œé‚£ç½‘ç«™ä¸è®©ä¸‹ï¼Œæ‰€ä»¥åªèƒ½å½•å±äº†ã€

æˆ‘ï¼šã€Œ... æˆ‘ç…ç…ã€

---

# ä¸¾ä¸ªæ —å­ ğŸŒ°

-   [taobao](https://item.taobao.com/item.htm?spm=a230r.1.14.16.3046293f6PM4vv&id=609798888729&ns=1&abbucket=14)
-   [zxx.edu.cn](https://www.zxx.edu.cn/syncClassroom/classActivity?activityId=b87b1ba3-7d58-440d-b5c9-2eb7a7a5faa6)

<br>
<br>
<br>

ç°åœ¨å¤§å¤šæ•°è§†é¢‘ç½‘ç«™ä¸ºäº†è§†é¢‘ç‰ˆæƒä¿æŠ¤ä¸åŠ è½½é€Ÿåº¦éƒ½ä¸ä¼šç›´æ¥ä½¿ç”¨ MP4 æ ¼å¼çš„èµ„æºï¼Œè¿›è€Œé‡‡ç”¨åœ¨æµè§ˆå™¨ç«¯è§£ç æ’­æ”¾çš„è§†é¢‘æ ¼å¼ï¼ŒM3U8 å°±æ˜¯æ¯”è¾ƒå¸¸è§çš„è§†é¢‘æ ¼å¼ã€‚
---

<div grid="~ cols-2 gap-4">

<div>

# M3U8ï¼ˆM3Uï¼‰æ ¼å¼

> M3U æ–‡ä»¶æ˜¯ä¸€ç§çº¯æ–‡æœ¬æ–‡ä»¶ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå¤šåª’ä½“æ–‡ä»¶çš„ä½ç½®ï¼Œå…¶æ–‡ä»¶æ‰©å±•åæ˜¯ â€œM3Uâ€ æˆ–è€… â€œm3uâ€ ã€‚M3U æ–‡ä»¶å…·æœ‰å¤šä¸ªæ¡ç›®ï¼Œæ¯ä¸ªæ¡ç›®çš„æ ¼å¼å¯ä»¥æ˜¯ä»¥ä¸‹å‡ ç§æ ¼å¼ä¹‹ä¸€ï¼š
>
> -   ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œæ¯”å¦‚ï¼šC:\My Music\Heavysets.mp3
> -   ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº M3U æ–‡ä»¶çš„è·¯å¾„ï¼‰ï¼Œæ¯”å¦‚ï¼šHeavysets.mp3
> -   ä¸€ä¸ª URL

> M3U8 æ˜¯ Unicode ç‰ˆæœ¬çš„ M3Uï¼Œç”¨ UTF-8 ç¼–ç ã€‚"M3U" å’Œ "M3U8" æ–‡ä»¶éƒ½æ˜¯è‹¹æœå…¬å¸ä½¿ç”¨çš„ HTTP Live Streaming æ ¼å¼çš„åŸºç¡€ï¼Œè¿™ç§æ ¼å¼å¯ä»¥åœ¨ iPhone å’Œ Macbook ç­‰è®¾å¤‡æ’­æ”¾ã€‚

[M3U ç»´åŸºç™¾ç§‘](https://zh.m.wikipedia.org/zh-hans/M3U)

</div>

<div>

# M3U8 ç¤ºä¾‹

```text
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-ALLOW-CACHE:YES
#EXT-X-TARGETDURATION:16
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:15.366444,
Sw1Nt2Yq6HL4SsaqIEp_248351438042___hd-00001.ts?auth_key=1669086240-0-0-8178ecf4fcca98d45973d9da97793aa2
#EXTINF:8.120000,
Sw1Nt2Yq6HL4SsaqIEp_248351438042___hd-00002.ts?auth_key=1669086240-0-0-a99a49c40ae2511cf0fb679e874852f7
#EXTINF:5.360000,
Sw1Nt2Yq6HL4SsaqIEp_248351438042___hd-00003.ts?auth_key=1669086240-0-0-773af2632be3df442900f8bd4f41a9ac
#EXT-X-ENDLIST

```

</div>

</div>

---

# M3U8 ä¸‹è½½è§£æ

```js
const fs = require('fs-extra');
const path = require('path');
const download = require('download');
const m3u8Parser = require('m3u8-parser');

const M3U8_URL = '';
const OUTPUT_DIR = 'output';
// m3u8 æ–‡ä»¶ä¸‹è½½
const downloadM3u8 = async () => {
    const m3u8OutputPath = path.resolve(__dirname, OUTPUT_DIR, 'index.m3u8');
    await fs.ensureDir(path.resolve(__dirname, OUTPUT_DIR));
    await fs.writeFile(m3u8OutputPath, await download(M3U8_URL));
    return m3u8OutputPath;
};
// m3u8 æ–‡ä»¶è§£æ
const parseM3u8 = async (filePath) => {
    const m3u8Content = await fs.readFile(filePath, 'utf-8');
    const parser = new m3u8Parser.Parser();
    parser.push(m3u8Content);
    parser.end();
    return parser.manifest;
};
```

---

# M3U8 è§£æ

```json
{
    "allowCache": true,
    "discontinuityStarts": [],
    "segments": [
        {
            "duration": 15.366444,
            "uri": "Sw1Nt2Yq6HL4SsaqIEp_248351438042___hd-00001.ts?auth_key=1669205423-0-0-74779306bc0158d01431cffb432760f0",
            "timeline": 0
        },
        {
            "duration": 8.12,
            "uri": "Sw1Nt2Yq6HL4SsaqIEp_248351438042___hd-00002.ts?auth_key=1669205423-0-0-2663934cc121402f9138e53d3675517b",
            "timeline": 0
        },
        {
            "duration": 5.36,
            "uri": "Sw1Nt2Yq6HL4SsaqIEp_248351438042___hd-00003.ts?auth_key=1669205423-0-0-d556e54b54753b0c115eedea8209b546",
            "timeline": 0
        }
    ],
    "version": 3
}
```

---

# M3U8 èµ„æºä¸‹è½½

```js
const downloadM3u8Segments = async (segments) => {
    const baseURL = path.dirname(M3U8_URL);
    const tasks = segments.map(async (item, index) => {
        const videoSegmentURL = `${baseURL}/${item.uri}`;
        // æœ‰äº›è§†é¢‘èµ„æºçš„è·¯å¾„ä¸­ä¼šå¸¦æœ‰ ?xxx=xxx çš„æŸ¥è¯¢å‚æ•°ï¼Œéœ€è¦å°†å…¶å‰”é™¤ï¼Œä¸‹è½½çš„è§†é¢‘æ–‡ä»¶åä¸º 0.ts 1.ts 2.ts
        const outputFileName = `${index}${path.extname(item.uri).replace(/\?.+$/g, '')}`;
        const videoSegmentOutput = path.resolve(__dirname, OUTPUT_DIR, outputFileName);
        await fs.writeFile(videoSegmentOutput, await download(videoSegmentURL));
        console.log(`${index}: ${item.uri} download ~`);
    });
    await Promise.all(tasks);

    // è¿™é‡Œç”Ÿæˆä¸€ä¸ª fileList.text æ¸…å•ï¼Œä¸€ä¼šå„¿ ffmpeg è½¬ç ä¼šç”¨åˆ°
    const fileList = segments.map((_, index) => `file ${index}.ts`);
    const fileListOutput = path.resolve(__dirname, OUTPUT_DIR, 'fileList.text');
    await fs.writeFile(fileListOutput, fileList.join('\n'));

    return fileListOutput;
};
```
---

# TS è§†é¢‘æ ¼å¼

> ts æ˜¯æ—¥æœ¬é«˜æ¸…æ‘„åƒæœºæ‹æ‘„ä¸‹è¿›è¡Œçš„å°è£…æ ¼å¼ï¼Œå…¨ç§°ä¸º MPEG2-TSã€‚ts å³ "Transport Stream" çš„ç¼©å†™ã€‚MPEG2-TS æ ¼å¼çš„ç‰¹ç‚¹å°±æ˜¯è¦æ±‚ä»è§†é¢‘æµçš„ä»»ä¸€ç‰‡æ®µå¼€å§‹éƒ½æ˜¯å¯ä»¥ç‹¬ç«‹è§£ç çš„ã€‚

[TS æ–‡ä»¶](https://baike.baidu.com/item/TS%E6%96%87%E4%BB%B6/9554188)
---



# FFmpeg

![FFmpeg](https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/FFmpeg_Logo_new.svg/2880px-FFmpeg_Logo_new.svg.png)

> FFmpeg æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„è‡ªç”±è½¯ä»¶ï¼Œå¯ä»¥æ‰§è¡ŒéŸ³é¢‘å’Œè§†é¢‘å¤šç§æ ¼å¼çš„å½•å½±ã€è½¬æ¢ã€ä¸²æµåŠŸèƒ½ï¼ŒåŒ…å«äº† libavcodecï¼ˆä¸€ä¸ªç”¨äºå¤šä¸ªé¡¹ç›®ä¸­éŸ³é¢‘å’Œè§†é¢‘çš„è§£ç å™¨åº“ï¼‰ï¼Œä»¥åŠ libavformatï¼ˆä¸€ä¸ªéŸ³é¢‘ä¸è§†é¢‘æ ¼å¼è½¬æ¢åº“ï¼‰

[https://ffmpeg.org/](https://ffmpeg.org/)

[https://zh.wikipedia.org/zh-cn/FFmpeg](https://zh.wikipedia.org/zh-cn/FFmpeg)

---

# FFmpeg æ‹¼æ¥è§†é¢‘

ä½¿ç”¨ FFmepg è¿›è¡Œè§†é¢‘æ‹¼æ¥è½¬ç 

fileList.text

```html
file 0.ts
file 1.ts
file 2.ts
```

è§†é¢‘æ‹¼æ¥æˆ MP4 æ ¼å¼
```bash
ffmpeg -f concat -safe 0 -i fileList.text output.mp4
```

---

# å¦‚ä½•åœ¨ Node ä¸­é›†æˆ FFmpeg

- æœ¬åœ°é›†æˆ
- ä½œä¸ºä¾èµ–å®‰è£…
    - [ffmpeg-static](https://github.com/eugeneware/ffmpeg-static)
    - [node-ffmpeg-installer](https://github.com/kribblo/node-ffmpeg-installer)
- WebAssembly
    - [ffmpeg.wasm](https://github.com/ffmpegwasm/ffmpeg.wasm)

---

# Node FFmpeg ä½¿ç”¨

```js 
const splicingVideos = async (fileListPath) => {
    // æœ¬åœ°å¦‚æœå®‰è£…äº† FFmepg åˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ ffmpeg æŒ‡ä»¤ï¼Œä¸éœ€è¦è£… ffmpeg-static ä¾èµ–
    const pathToFfmpeg = require('ffmpeg-static');
    const cmd = `${pathToFfmpeg} -f concat -safe 0 -i ${fileListPath}  output.mp4`;
    await new Promise((resolve, reject) => {
        console.log(`run : ${cmd}`);
        const task = exec(cmd, (error) => {
            if (error) {
                return reject(error);
            }
            console.log('done~');
            resolve();
        });
        task.stderr.on('data', (data) => console.log(data));
    });
    await open('output.mp4');
};
```

---

# å…¶ä»–

- ä¸‹è½½ m3u8 æ–‡ä»¶
- è§£æ m3u8 æ–‡ä»¶
- æŒ‰é¡ºåºä¸‹è½½ m3u8 ä¸­çš„è§†é¢‘ç‰‡æ®µ
- ä½¿ç”¨ FFmpeg æ‹¼æ¥è½¬ç 

https://github.com/kinglisky/mi.scripts/tree/master/scripts/m3u8.download

https://github.com/kinglisky/mi.scripts/blob/master/articles/m3u8.download.md